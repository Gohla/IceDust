module api/data-api

imports // constructors

	signatures/Data-sig
	signatures/Modules-sig
	signatures/Model-sig
  desugaring/constructors

imports // functions
		
	lib/origin

rules // query
	
	datadef-get-data = ?DataDef(<id>)
	
  entityinstance-get-type = ?EntityInstance(_, EntityRef(<id>), _)
  entityinstance-get-type = ?EntityInstance(_, <id>, _) // no type in concrete syntax (type inferred)
	entityinstance-get-name = ?EntityInstance(<id>, _, _)
	entityinstance-get-rolevalues = ?EntityInstance(_, _, <id>)
	entityinstance-get-attrvalues = ?EntityInstance(_, _, <id>)
	entityinstance-get-membervalues = ?EntityInstance(_, _, <id>)
	
	rolevalue-get-role       = ?RoleValue(RoleRef(<id>), _)
	rolevalue-get-value      = ?RoleValue(_, <id>)
	
	attributevalue-get-attr  = ?AttributeValue(AttributeRef(<id>),_)
	attributevalue-get-value = ?AttributeValue(_,<id>)
  
  membervalue-get-name = ?MemberValue(MemberRef(<id>), _)
  membervalue-get-name = ?MemberValue(NaBLHelp(_, <id>), _)
  membervalue-get-membername = ?MemberValue(MemberRef(<id>), _)
  membervalue-get-membername = ?MemberValue(NaBLHelp(MemberRef(<id>), _), _)
  membervalue-get-expr = ?MemberValue(_, <id>)

rules // properties
	
	is-datadef = ?DataDef(_)
	
	is-entityinstance = ?EntityInstance(_, _, _)
	
	is-attributevalue = ?AttributeValue(_,_)
	is-rolevalue      = ?RoleValue(_, _)

  is-membervalue = ?MemberValue(_,_)

	entityinstance-has-no-name = ?EntityInstance(None(), _, _)

rules // manipulate
	
	datadef-set-data(|op) = DataDef(!op)
	
	entityinstance-set-name(|name) = EntityInstance(!name, id, id)
	
	membervalue-set-member(member) = MemberValue(member, id)
	
	membervalue-dup-member   = membervalue-set-member(\r@MemberRef(m) -> NaBLHelp(r, m)\)
	membervalue-dedup-member = membervalue-set-member(\NaBLHelp(r, _) -> r\)
	
rules // representations    
  
  entityinstance-to-entityinstanceref: EntityInstance(ei, ty, members) -> EntityInstanceRef(ei)
  entityinstance-to-entityinstanceref: RelationInstance(ei, ty, members) -> EntityInstanceRef(ei)

rules

  membervalue-getall-einames = collect-all(eiwrefnames)

  eirefname: EntityInstanceRef(name) -> name
  eiwrefnames: EntityInstanceWrapper(EntityInstanceRef(relname), EntityInstanceRef(name)) -> (relname,name)
  eiwrefnames: EntityInstanceWrapper(None(), EntityInstanceRef(name))                                       -> (None(),name)
  